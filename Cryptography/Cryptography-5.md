---
title: Cryptography-5:Message Authentication Code
categories:
- Cryptography 
mathjax: true
---

基于《图解密码技术》@[日]结城浩



# 简介

消息认证码，简称**MAC**，是一种确认完整性并进行认证的技术

输入：任意长度的**消息**；发送者与接收者**共享的密钥**

输出：固定长度的数据，称为**MAC值**

消息认证码的实现方式很多，暂且可以理解为**一种与密钥相关联的单向散列函数**

下图是一个简单的使用步骤模型

![MAC0](https://s1.ax1x.com/2020/08/14/dC4JZF.png)



# HMAC

HMAC是一种使用单向散列函数来构造消息认证码的方法，HMAC中的H表示Hash

借助下图梳理一下HMAC的步骤

![MAC1](https://s1.ax1x.com/2020/08/14/dC4IL8.png)

## STEP1 密钥填充:

如果密钥比单向散列函数的分组长度短，则在末尾填充0，直到长度等于分组长度

如果密钥比单向散列函数的分组长度长，则求出其散列值，将其作为HMAC的密钥

## STEP2 填充后密钥与ipad进行XOR:

**ipad**是将$00110110$这一比特序列不断循环反复直到达到分组长度形成的比特序列，**ipad**中的**i**是指**inner**

XOR运算后的比特序列称为**ipadkey**

## STEP3 与消息组合:

将**ipadkey**附加在消息的开头

## STEP4 计算散列值:

将上一步结果输入单向散列函数，并计算出散列值

## STEP5 填充后的密钥与opad进行XOR:

**opad**是将$01011100$这一比特序列不断循环反复直到达到分组长度形成的比特序列，**opad**中的**o**是指**outer**

XOR运算后的比特序列称为**opadkey**

## STEP6 与散列值组合

将STEP4的结果拼在**opadkey**后面

## STEP7 计算散列值

将上一步结果输入单向散列函数，并计算出散列值，即为**MAC值**



# 攻击

## 重放攻击

Mallory可以通过事先保存正确的MAC值不断重放来发动攻击，这一过程中Mallory并没有破解MAC

i.e.

Mallory到Alice银行向自己在Bob银行中的账户汇款100万

Mallory窃听Alice银行发送给Bob银行的汇款请求消息以及MAC值，并保存下来

Mallory把保存下来的数据发送给Bob银行，重复100次

Mallory去Bob银行成功取出一亿元

存在几种防御重放攻击的方法

- 序号：约定每次都对发送的消息赋予一个递增的序号，这种方法有效，但是对每个通信对象都需要记录最后一个消息的序号
- 时间戳：约定在发送消息时包含当前的时间，虽然有效，但是发送与接收者的时钟必须一致，而且考虑到通信延迟，必须在时间的判断上留下缓冲，于是多少还是存在可以进行重放攻击的空间
- nonce：在通信前，接收者先向发送者发送一个一次性的随机数，这种方法虽然有效，但是通信数据量会有所增加

## 密钥推测攻击

和对单向散列函数的攻击一样，对MAC也可以进行**暴力破解**和**生日攻击**



# 无法解决的问题

MAC无法达到**对第三方证明**和**防止否认**，他们的解决方案是使用**数字签名**，会在后面讲到

















