---
title: OpenCV9-Feature Point Detection and Matching
categories:
- OpenCV
mathjax: true

---

基于《OpenCV4快速入门》 @冯振、郭延宁、吕跃勇

# 角点检测

角点就是在某方面属性特别突出的点，例如像素最大或者最小的点、线段的顶点、孤立的边缘点等

## 显示关键点

关键点是对图像中含有特殊信息的像素点的一种称呼，有时我们经过计算或已知这些点并且需要标记出来

OpenCV4提供了用于一次性绘制所有关键点的函数**drawKeyPoints**

## Harris角点检测

Harris角点从像素值变化的角度对角点进行定义，像素值的局部最大峰值即为Harris角点

首先以某个像素为中心构建一个矩形滑动窗口，其覆盖的图像像素通过线性叠加得到滑动窗口所有像素值的衡量系数，该系数与滑动窗口范围内的像素值成正比，在图像中以每一个像素为中心向各个方向移动滑动窗口，当无论向哪个方向移动像素值衡量系数都缩小时，窗口中心点对应的像素即为Harris角点

下图是一个示意图，可见只有在P3中才能达到Harris角点的定义条件

![harris角点](https://tse3-mm.cn.bing.net/th/id/OIP.6XCS05IOAcqz0SfXHtDLYwHaEX?pid=Api&rs=1)



Harris角点检测原理可以用下式描述
$$
E(u,v)=\sum_{x,y}w(x,y)[I(x+u,y+v)-I(x,y)]^2
$$
其中$w(x,y)$表示滑动窗口权重函数，可以是常数也可以是高斯函数. $E(u,v)$是窗口向各个方向移动时像素值衡量系数的变化. 对上式泰勒展开得到
$$
E(u,v) =[u\quad v]M\left[\begin{array}{c}u\\v \end{array}\right]
$$
其中$M$是计算Harris角点的梯度协方差矩阵$\left[\begin{array}{cc} I_xI_x&I_xI_y\\I_xI_y&I_yI_y \end{array}\right]$ 其中$I_x和I_y$分别表示X和Y方向的梯度

进一步简化，定义Harris角点的评价系数$R$如下式
$$
R=det(M)-k(tr(M))^2
$$
其中$k$为常值权重系数，$det(M)=\lambda_1\lambda_2，tr(M)=\lambda_1+\lambda_2，\lambda_1和\lambda_2是梯度协方差矩阵M的特征向量$，将特征向量带入上式
$$
R=\lambda_1\lambda_2-k(\lambda_1+\lambda_2)^2
$$
当R较大，角点；R<0，位于直线上；|R|较小时，位于平面上

OpenCV4提供了**cornerHarris**函数用于计算Harris角点的评价系数$R$



## Shi-Tomas角点检测

是Harris角点的一种变形，将特征向量的最小值作为角点评价系数，具体如下
$$
R=min(\lambda_1,\lambda_2)
$$
当$R$大与某一阈值，则判断它为角点

OpenCV4提供了**goodFeaturesToTrack**函数直接检测Shi-Tomas角点



## 亚像素级别角点检测

目前的角点都是像素级别，即角点坐标是整数，但有时在实际项目中需要更高精度的亚像素级别的角点坐标

OpenCV4提供了**cornerSubPix**函数根据像素级别角点坐标计算亚像素级别角点



# 特征点检测

特征点由关键点和描述子组成

## 关键点

关键点在OpenCV4中由**KeyPoint**类表示，**detect**函数能够直接计算关键点

## 描述子

描述子是用来唯一描述关键点的一串数字，通过描述子可以区分两个不同关键点，也可以在两幅图像中寻找同一个关键点

OpenCV4提供了用于计算每种特征点描述子的**compute**函数

## SIFT特征点检测

比较复杂，篇幅较长，懒得缩写，赶紧看书

OpenCV4提供了$SIFT::create$函数实现

## SURF特征点检测

是SIFT特征点的改进，OpenCV4提供了**SURF::create**函数实现

## ORB特征点检测

ORB特征点由FAST角点和BRIEF描述子组成

FAST角点通过比较图像像素灰度值变化确定关键点，其核心思想是：如果在某个灰度值较小的区域中存在一个灰度值明显较大的像素点，那么该像素点在这个区域中具有明显的特征，可以作为特征点

BRIEF描述子用于描述特征点周围像素灰度值的变化趋势

OpenCV4提供了**ORB::create**实现

# 特征点匹配



## DescriptorMatcher类介绍

与计算特征点相似，OpenCV4提供了特征点匹配的虚类，类中定义了不同方式实现特征点匹配的函数

用于匹配的特征点描述子集合分别称为查询描述子集合和训练描述子集合

具体函数和使用方法不详细关注了

## 暴力匹配

暴力匹配就是计算训练描述子集合中每个训练描述子与查询描述子之间的距离，之后将所有距离排序，选择距离最小的或者满足阈值要求的描述子作为匹配结果

OpenCV4提供了**BFMatcher**函数实现暴力匹配

## 显示特征点匹配结果

OpenCV4提供了**drawMatches**函数用于显示两幅图像中特征点匹配结果

## FLANN匹配

快速最近邻搜索，OpenCV4提供了**FlannBasedMatcher**实现

## RANSAC优化特征点匹配

RANSAC算法是随机抽样一致算法简写

该算法假设所有数据符合一定规律，通过随机抽样方式获取这个规律，并且通过重复获取规律寻找使得较多数据符合的规律

RANSAC算法优化特征点检测可以概括为以下三步

1. 在匹配结果中随机选择4对特征点，计算单应矩阵
2. 将第一帧图像中的特征点根据单应矩阵求取在第二帧图像中的重投影坐标，比较重投影坐标与已匹配的特征点坐标之间的距离，如果小于一定阈值，那么认为是正确匹配点对，否则视为错误匹配，并记录正确匹配点对的数量
3. 重复第一第二步，比较多次循环后统计的正确匹配点对的数量，将正确匹配点对数量最多的情况作为最终结果，剔除错误匹配，输出正确匹配对，从而实现特征点匹配的筛选

OpenCV4提供了**findHomography**函数实现



















