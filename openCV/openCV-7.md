---
title: OpenCV7-Target Detection
categories:
- OpenCV
mathjax: true

---

基于《OpenCV4快速入门》 @冯振、郭延宁、吕跃勇

# 形状检测

## 直线检测

借助霍夫变换，主要思想是将图像像素从原本所在的空间坐标系变换到另一个空间坐标系，把检测形状问题转化成统计峰值问题

先来看简单的，对于直线$y=kx+b$可以从x-y坐标系变换到k-b坐标系，变换后k-b空间中一条直线对应x-y空间中的一个点，k-b空间中一个点对应x-y空间中的一条线，好处是显而易见的，可以通过寻找k-b空间中大量直线相交的点来发现直线

以下是一个直观的例子示意图

![霍夫变换1](https://s2.ax1x.com/2019/02/24/k46Rm9.png)

很容易想到它的不足，当图像中存在垂直直线时，变换后的空间中出现多条直线平行

![霍夫变换2](https://s2.ax1x.com/2019/02/24/k4cGA1.png)

故而可以选择使用极坐标系作为参数空间

![霍夫变换3](https://s2.ax1x.com/2019/02/24/k42eQU.png)

![霍夫变换4](https://s2.ax1x.com/2019/02/24/k4Rn9P.png)



总结一下，霍夫变换的四个主要步骤：

1. 将参数空间的坐标轴离散化，上面没有提到，但是很容易理解因为像素是离散的
2. 将图像中每个非零像素进行映射，求取在参数空间内的所在方格
3. 统计参数空间内每个方格出现次数，选取次数大与某阈值的方格作为表示直线的方格
4. 将参数空间中表示直线的方格的参数作为原图像中直线的参数

OpenCV4提供了**HoughLInes**函数实现霍夫变换，以及渐进概率式霍夫变换**HoughLInesP**

## 直线拟合

OpenCV4提供了利用最小二乘M-estimator方法拟合直线的**fitLine**函数

## 圆形检测

也是利用霍夫变换，数学描述和示意图如下
$$
x=a+Rcos(\theta) \\
y=b+Rsin(\theta)
$$
![霍夫变换-圆形](https://pic1.zhimg.com/v2-4b18037dffd5e99d163f62c79ba0aedc_r.jpg)

OpenCV4提供了**HoughCircles**函数进行基于霍夫变换的圆形检测



# 轮廓检测

## 轮廓发现与绘制

图像轮廓不但能够提供物体的边缘，而且能够提供物体边缘之间的层次关系和拓扑关系

为了描述不同轮廓之间的结构关系，定义由外到内的轮廓级别越来越低，也就是高一层的轮廓包围着低一层的轮廓

为了清晰表明各个轮廓之间的层级关系，常用4个参数来描述不同层级之间的结构关系

$[同层下一个轮廓的索引，同层上一个轮廓的索引，下一层第一个子轮廓的索引，上层父轮廓索引]$

整体结构是一颗树，具体例子看书

OpenCV4提供了可以在二值图像中检测图像所有轮廓并生成不同轮廓结构关系的**findContours**函数，也提供了显示轮廓的**drawContours**函数

## 轮廓面积

OpenCV4提供了检测轮廓面积的**contourArea**函数

## 轮廓长度(周长)

OpenCV4提供了检测轮廓长度的**arcLength**函数

## 轮廓外接多边形

物体轮廓的不规则不利于对图像内容进行分析，需要将物体的轮廓拟合成规则的几何形状

OpenCV4提供了求取轮廓最大外接矩形的**boundingRect**函数、最小外接矩形的**minAreaRect**函数和多边形的**approxPolyDP**函数

## 点到轮廓距离

OpenCV4提供了**pointPolygonTest**函数

## 凸包检测

将二维平面上的点集最外层的点连接起来构成的凸多边形称为凸包

# 矩的计算

矩是描述图像特征的算子

## 几何矩与中心矩

几何矩计算方式如下
$$
m_{ij}=\sum_{x,y}I(x,y)x^jy^i
$$
当$i=j=0$时，称为零阶矩，可以用于计算某个形状的质心

当$i=0,j=1$时，称为一阶矩，以此类推

图像质心的计算公式如下
$$
\overline{x}=\frac{m_{10}}{m_{00}},\overline{y}=\frac{m_{01}}{m_{00}}
$$
图像中心矩的计算方式如下
$$
mu_{ji}=\sum_{x,y}I(x,y)(x-\overline{x})^j(y-\overline{y})^i
$$
图像归一化几何矩的计算方式如下
$$
nu_{ji}=\frac{mu_{ji}}{m_{00}^{(i+j)/2+1}}
$$
OpenCV4提供了**moments**函数计算图像矩



## Hu矩

Hu矩具有旋转、平移和缩放不变性，因此在图像具有旋转和缩放情况下，Hu矩具有更广泛应用

Hu矩是由二阶和三阶中心矩计算得到7个不变矩，计算方法如下

![Hu矩](https://img-blog.csdnimg.cn/20190316185220150.png)

OpenCV4提供了**HuMoments**函数计算Hu矩



## 基于Hu矩的轮廓匹配

OpenCV4提供了**MatchShapes**函数进行基于Hu矩的轮廓匹配



# 点集拟合

有时我们关注的区域是一些面积较小、数目较多的连通域或者像素点，并且他们相对集中. 此时如果寻找轮廓并多边形逼近，会产生大量多边形，我们可以将这些连通域或者像素点看成一个大区域，再寻找包围大区域的规则图形

OpenCV4提供了**minEnclosingTriangle**函数实现寻找二维点集的最小包围三角，当然还有最小包围圆形的**minEnclosingCircle**



# QR二维码检测

二维码顶点方向有3个较大的“回”字形区域用于对二维码进行定位，该区域的特别之处在与任何一条经过中心的直线在黑色和白色区域的长度比值都为$1:1:3:1:1$

二维码中间也具有多个较小的“回”字形区域用于二维码对齐

![QR](http://static.oschina.net/uploads/img/201310/16121257_i3Sp.png)



识别QR二维码大致分为探测和解码两个过程

OpenCV4提供了**detect**函数实现二维码定位，提供了**decode**函数实现解码，提供了**detectAndDecode**同时定位和解码





















